# NS-CWP-013 — RUNBOOK

## 0. Overview

This runbook defines operational procedures for **CWP (Cognitive Work Plane)**.

CWP is the operational coordination layer for:

* work intake, task routing, and assignment
* playbook (SOP) execution
* approvals and human-in-the-loop steps
* SLA monitoring and escalation
* evidence attachment and completion verification

CWP is not governance authority (GGP) and does not execute money movement (FLO). CWP orchestrates and supervises.

---

## 1. On-Call & Support Model

### 1.1 Roles

* **CWP On-Call**: primary responder for CWP platform issues
* **Queue Operator**: triage and routing authority (within policy)
* **Supervisor**: handles escalations and stuck work
* **Approver(s)**: role-limited approval responders

### 1.2 Severity guidance

* **SEV0**: CWP down in prod; critical work cannot be created/routed; approvals blocked org-wide
* **SEV1**: assignment/routing broken for prod queues; SLA engine not firing; state transitions failing broadly
* **SEV2**: partial degradation (one queue, one playbook family, notifications failing)
* **SEV3**: minor UI glitches, delayed metrics, non-critical features impacted
* **SEV4**: informational/maintenance

### 1.3 First response checklist (any CWP alert)

1. Confirm **environment** (prod vs non-prod).
2. Determine **blast radius** (all queues vs single queue; all playbooks vs one).
3. Check **current incidents** (avoid duplicate incident).
4. Check core health dashboards (Section 2).
5. If SEV0/SEV1: open incident and assign IC/Supervisor.

---

## 2. Core Dashboards (Minimum)

### 2.1 Work Plane Health

* task create rate
* task transition rate
* error rate (4xx/5xx)
* latency p95 for key endpoints

### 2.2 Queue & Assignment Health

* queued count by queue
* assignment throughput
* unassigned backlog age
* worker availability distribution

### 2.3 SLA Health

* tasks due soon / breached
* SLA evaluator lag
* escalation ladder activity

### 2.4 Approvals Health

* approvals pending count
* median approval latency
* expired approvals
* top approval bottlenecks by approver role

### 2.5 Playbook Runtime Health

* step execution success/failure
* blocked step count
* retries and timeouts

### 2.6 Notifications Health (via MUX)

* notifications queued/sent/failed
* delivery confirmations (if available)

### 2.7 Evidence Health

* tasks blocked due to missing evidence
* evidence attachment error rates
* invalid/broken refs

---

## 3. Common Failure Modes & Playbooks

## 3.1 Task Creation Failures

**Symptoms**

* new tasks cannot be created
* inbound event-driven tasks not appearing

**Immediate checks**

1. Check API health and error logs.
2. Confirm DB connectivity and write latency.
3. Confirm idempotency conflicts are not misconfigured.

**Mitigations**

* roll back recent deploy
* enable degraded mode: accept tasks but defer heavy validation
* temporarily disable non-critical enrichment

**Validation**

* task creation resumes
* `cwp.task.created` events present in LUM

## 3.2 Backlog Explosion / Routing Broken

**Symptoms**

* queue backlog grows quickly
* tasks remain unassigned

**Immediate checks**

1. Confirm queue is not `paused`.
2. Confirm routing rules match tasks.
3. Confirm workers are `available` and eligible.
4. Confirm assignment engine is running and not rate-limited.

**Mitigations**

* temporarily switch to manual triage/assignment
* relax eligibility constraints only if policy allows (otherwise escalate)
* increase assignment worker capacity

**Validation**

* unassigned age decreases
* assignment rate returns to baseline

## 3.3 Invalid State Transition Spikes

**Symptoms**

* frequent `ERR_INVALID_TRANSITION`
* workers cannot move tasks forward

**Immediate checks**

1. Identify top failing transitions and the triggering UI/workflow.
2. Verify the task’s current state and required prerequisites.
3. Check if a playbook step is gating the transition.

**Mitigations**

* fix UI/client sending incorrect transition
* apply hotfix to state machine if bugged
* if data corruption: run reconciliation script (Section 5)

**Validation**

* transitions succeed
* transition events emitted to LUM

## 3.4 SLA Engine Not Firing / Escalations Missing

**Symptoms**

* overdue tasks but no breach events
* no escalations generated

**Immediate checks**

1. SLA evaluator scheduler running?
2. Timezone/time math errors?
3. Are tasks missing SLA policy bindings?
4. Are escalation destinations configured?

**Mitigations**

* restart SLA evaluator
* backfill missed SLA events
* temporarily enable conservative breach alerts

**Validation**

* new breaches detected
* escalations created and routed

## 3.5 Approvals Stuck (Pending / Not Delivering)

**Symptoms**

* approvals pending with no responder
* approvers claim they never received notification

**Immediate checks**

1. Confirm approval state and assignee.
2. Confirm IDN eligibility resolution (was assignee valid?).
3. Confirm MUX notification send + delivery.
4. Confirm GGP decision workflow functioning.

**Mitigations**

* resend approval request
* re-resolve approver set (IDN) and reassign
* if GGP unavailable, pause governed steps and create incident

**Validation**

* approval action recorded
* `decision_id` attached

## 3.6 Playbook Runner Degraded (Steps Not Progressing)

**Symptoms**

* steps remain `running` indefinitely
* steps fail repeatedly
* integration steps timing out

**Immediate checks**

1. Identify affected playbook_id/version.
2. Inspect step execution logs and retry behavior.
3. Confirm integration dependencies (MUX, external providers).

**Mitigations**

* pause playbook runs for affected playbook (queue pause)
* force step to `blocked` with reason + handoff to human
* roll back playbook version if regression

**Validation**

* new runs complete
* stuck runs moved to blocked/handled

## 3.7 Evidence Attachment Failures / Completion Blocked

**Symptoms**

* tasks cannot be completed due to missing evidence
* broken links / missing hashes

**Immediate checks**

1. View required evidence checklist for the task.
2. Verify storage refs are accessible.
3. Confirm evidence classification rules.
4. If governed: confirm GGP evidence requirements are attached.

**Mitigations**

* attach replacement artifact and supersede old
* run evidence validator
* if storage outage, switch to alternate storage or defer completion

**Validation**

* evidence state transitions to `validated`
* task completion allowed

## 3.8 Notification Failures (Email/Chat)

**Symptoms**

* notifications stuck in queued
* high failure rate

**Immediate checks**

1. MUX connector status.
2. Rate limits / provider errors.
3. Message template errors.

**Mitigations**

* retry with backoff
* switch to fallback channel
* reduce notification volume (batch)

**Validation**

* delivery resumes

---

## 4. External Engine Dependency Runbooks

### 4.1 If GGP is degraded

**Impact**

* approvals and governed gates may stall

**Actions**

1. Switch CWP to “governed-degraded mode”: do not advance gated steps.
2. Continue non-governed work where safe.
3. Create incident and notify governance stakeholders.

**Recovery validation**

* decisions return; gated steps resume

### 4.2 If IDN is degraded

**Impact**

* assignee/approver eligibility resolution fails

**Actions**

1. Freeze auto-assignment for affected queues.
2. Use cached eligibility where permitted.
3. Escalate to IDN owners.

### 4.3 If MUX is degraded

**Impact**

* notifications and integration calls fail

**Actions**

1. Pause playbook steps that require outbound calls.
2. Prefer manual steps.
3. Queue outbound requests for replay.

### 4.4 If FLO is degraded

**Impact**

* payment and ledger steps cannot complete

**Actions**

1. Block tasks at payment step.
2. Notify finance operators.
3. Ensure evidence capture continues.

### 4.5 If LUM is degraded

**Impact**

* reduced visibility, but work may continue

**Actions**

1. Continue work; ensure local logs retained.
2. Backfill events once LUM recovers.

---

## 5. Operational Tools & Procedures

### 5.1 Reconciliation job (recommended)

Runs periodically to detect:

* tasks stuck in impossible states
* missing owners for assigned/in_progress tasks
* approvals missing decision references
* SLA timers missing policy bindings

Outputs

* reconciliation report
* auto-fix safe cases; flag risky cases for human review

### 5.2 Manual override (break-glass)

Only if GGP policy allows.

Requirements

* record rationale
* attach evidence of authorization
* emit `decision_id` reference (or a special break-glass decision)

### 5.3 Backfill events to LUM

If event emission failed:

* replay task transition history to LUM
* mark events as `backfilled=true`

---

## 6. Escalation & Communication

### 6.1 When to open an incident

* SEV0/SEV1 always
* SEV2 if affects critical workflows or sustained > threshold

### 6.2 Stakeholder comms template

* What is broken
* Impacted queues/playbooks
* Current mitigation
* ETA for next update (time-boxed update cadence)
* Owner/IC

---

## 7. Postmortem Requirements

For SEV0–SEV2 incidents:

* incident timeline
* root cause
* contributing factors
* what detection missed (if any)
* corrective actions
* action items created in CWP with owners and SLAs

---

## 8. Quick Operational Queries (Conceptual)

(Implement as scripts once stack is chosen.)

* list tasks stuck > N hours by queue
* list approvals pending > N hours by approver role
* list tasks blocked due to missing evidence
* list SLA-breached tasks without escalations
